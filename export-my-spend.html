<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Export Spendings CSV</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f9fafb}
.container{max-width:500px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc}
button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
</style>
</head>
<body>
<div class="container">
<h2>ðŸ’¾ Export Spendings CSV</h2>
<div id="authSection">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<div id="appSection" style="display:none">
<button onclick="exportCSV()">â¬‡ Export CSV</button>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase, ref, get} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import {getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
    apiKey:"AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
    authDomain:"striped-acrobat-342207.firebaseapp.com",
    databaseURL:"https://striped-acrobat-342207-default-rtdb.firebaseio.com",
    projectId:"striped-acrobat-342207"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const salariesRef = ref(db, "spending/salaries");
const expensesRef = ref(db, "spending/items"); // assuming items have a category field

const authSection = document.getElementById("authSection");
const appSection = document.getElementById("appSection");

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(err => alert(err.message));

window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
    authSection.style.display = user ? "none" : "block";
    appSection.style.display = user ? "block" : "none";
});

window.exportCSV = async () => {
    // Fetch data
    const salariesSnap = await get(salariesRef);
    const expensesSnap = await get(expensesRef);

    // Salaries
    const salaries = [];
    let totalSalary = 0;
    salariesSnap.forEach(c => {
        const s = c.val();
        salaries.push(s);
        totalSalary += s.amount;
    });

    // Expenses grouped by category
    const expenses = {};
    expensesSnap.forEach(c => {
        const e = c.val();
        if (!expenses[e.category]) expenses[e.category] = 0;
        expenses[e.category] += e.amount;
    });

    // CSV header
    let csv = "Category,Name/Desc,Amount,Percentage of Salaries (%)\n";

    // Salaries section
    csv += `Salaries Total, ,${totalSalary},100%\n`;
    salaries.forEach(s => {
        csv += `Salary,${s.name},${s.amount},${((s.amount/totalSalary)*100).toFixed(1)}%\n`;
    });

    // Expenses section as % of salaries
    csv += `Expenses Total, ,${Object.values(expenses).reduce((a,b)=>a+b,0)},${(Object.values(expenses).reduce((a,b)=>a+b,0)/totalSalary*100).toFixed(1)}%\n`;
    for (const cat in expenses) {
        csv += `Expense Category,${cat},${expenses[cat]},${((expenses[cat]/totalSalary)*100).toFixed(1)}%\n`;
    }

    // Download CSV
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "spendings_relative_to_salaries.csv";
    a.click();
};
</script>
</body>
</html>
