<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Export Spendings CSV</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f9fafb}
.container{max-width:500px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc}
button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
</style>
</head>
<body>
<div class="container">
<h2>ðŸ’¾ Export Spendings CSV</h2>
<div id="authSection">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<div id="appSection" style="display:none">
<button onclick="exportCSV()">â¬‡ Export CSV</button>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase,ref,get} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import {getAuth,signInWithEmailAndPassword,signOut,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig={
    apiKey:"AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
    authDomain:"striped-acrobat-342207.firebaseapp.com",
    databaseURL:"https://striped-acrobat-342207-default-rtdb.firebaseio.com",
    projectId:"striped-acrobat-342207"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const salariesRef = ref(db, "spending/salaries");
const inwardRef = ref(db, "spending/inwardCash");
const itemsRef = ref(db, "spending/items");

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value);
window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
    authSection.style.display = user ? "none" : "block";
    appSection.style.display = user ? "block" : "none";
});

window.exportCSV = async () => {
    // Fetch data
    const salariesSnap = await get(salariesRef);
    const inwardSnap = await get(inwardRef);
    const expensesSnap = await get(itemsRef);

    // Prepare arrays & totals
    const salaries = []; let totalSalary = 0;
    salariesSnap.forEach(c => { const v = c.val(); salaries.push(v); totalSalary += v.amount; });

    const inwards = []; let totalInward = 0;
    inwardSnap.forEach(c => { const v = c.val(); inwards.push(v); totalInward += v.amount; });

    const expenses = []; let totalExpenses = 0;
    expensesSnap.forEach(c => { const v = c.val(); expenses.push(v); totalExpenses += v.amount; });

    const totalFunds = totalSalary + totalInward;

    // CSV header
    let csv = "Type,Name/Desc,Amount,Percentage of Total Funds (%)\n";

    // Add category totals first
    csv += `Salaries Total, ,${totalSalary},${((totalSalary/totalFunds)*100).toFixed(1)}%\n`;
    salaries.forEach(s => csv += `Salary,${s.name},${s.amount},${((s.amount/totalFunds)*100).toFixed(1)}%\n`);

    csv += `Inward Cash Total, ,${totalInward},${((totalInward/totalFunds)*100).toFixed(1)}%\n`;
    inwards.forEach(i => csv += `Inward Cash,${i.name},${i.amount},${((i.amount/totalFunds)*100).toFixed(1)}%\n`);

    csv += `Expenses Total, ,${totalExpenses},${((totalExpenses/totalFunds)*100).toFixed(1)}%\n`;
    expenses.forEach(e => csv += `Expense,${e.desc},${e.amount},${((e.amount/totalFunds)*100).toFixed(1)}%\n`);

    // Summary row
    csv += `TOTAL FUNDS, ,${totalFunds},100%\n`;

    // Download CSV
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "spendings_export.csv";
    a.click();
};
</script>
</body>
</html>
