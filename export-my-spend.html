<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Export Spendings CSV</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f9fafb}
.container{max-width:500px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc}
button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
</style>
</head>
<body>
<div class="container">
<h2>ðŸ’¾ Export Spendings CSV</h2>
<div id="authSection">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<div id="appSection" style="display:none">
<button onclick="exportCSV()">â¬‡ Export CSV</button>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase, ref, get} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import {getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
    apiKey:"AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
    authDomain:"striped-acrobat-342207.firebaseapp.com",
    databaseURL:"https://striped-acrobat-342207-default-rtdb.firebaseio.com",
    projectId:"striped-acrobat-342207"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const salariesRef = ref(db, "spending/salaries");
const inwardRef = ref(db, "spending/inwardCash");
const itemsRef = ref(db, "spending/items");

const authSection = document.getElementById("authSection");
const appSection = document.getElementById("appSection");

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(err => alert(err.message));

window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
    authSection.style.display = user ? "none" : "block";
    appSection.style.display = user ? "block" : "none";
});

window.exportCSV = async () => {
    // Fetch data
    const salariesSnap = await get(salariesRef);
    const inwardSnap = await get(inwardRef);
    const expensesSnap = await get(itemsRef);

    let totalSalary = 0;
    salariesSnap.forEach(c => totalSalary += c.val().amount);

    let totalInward = 0;
    inwardSnap.forEach(c => totalInward += c.val().amount);

    let totalExpenses = 0;
    expensesSnap.forEach(c => totalExpenses += c.val().amount);

    const totalFunds = totalSalary + totalInward + totalExpenses;

    // CSV header
    let csv = "Category,Total Amount,Percentage of Total Funds (%)\n";

    // Category-wise totals & %
    csv += `Salaries,${totalSalary},${((totalSalary/totalFunds)*100).toFixed(1)}%\n`;
    csv += `Inward Cash,${totalInward},${((totalInward/totalFunds)*100).toFixed(1)}%\n`;
    csv += `Expenses,${totalExpenses},${((totalExpenses/totalFunds)*100).toFixed(1)}%\n`;

    // Total row
    csv += `TOTAL FUNDS,${totalFunds},100%\n`;

    // Download CSV
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "spendings_export_categories.csv";
    a.click();
};
</script>
</body>
</html>
