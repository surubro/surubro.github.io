<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Expenses Manager</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9fafb; color: #333; }
.container { max-width: 500px; margin: auto; padding: 20px; }
h2 { text-align: center; margin-bottom: 20px; }
.card { background: white; padding: 15px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.card small { display: block; color: #777; margin-top: 4px; }
input, button, select { width: 100%; padding: 10px; margin: 6px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
button { background: #4f46e5; color: white; border: none; cursor: pointer; }
button:hover { background: #4338ca; }
.delete { background:#dc2626; }
.delete:hover { background:#b91c1c; }
.actions { display:flex; justify-content:flex-end; }
</style>
</head>
<body>
<div class="container">
<h2>ðŸ’° Expenses Manager</h2>

<div id="authSection">
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<div id="appSection" style="display:none;">

<input type="text" id="descInput" placeholder="Expense Description">
<input type="number" id="amountInput" placeholder="Expense Amount">
<select id="categorySelect"></select>
<select id="incomeSelect"></select>
<button onclick="addExpense()">Add Expense</button>

<!-- NEW BUTTON -->

<button class="delete" onclick="deleteAllExpenses()">Delete All Expenses</button>

<h3>Expenses</h3>
<div id="list"></div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
apiKey: "AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
authDomain: "striped-acrobat-342207.firebaseapp.com",
databaseURL: "https://striped-acrobat-342207-default-rtdb.firebaseio.com",
projectId: "striped-acrobat-342207"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const incomesRef = ref(db, "expenses/incomes");
const expensesRef = ref(db, "expenses/items");
const categoriesRef = ref(db, "expenses/categories");

const PASSWORD = "Confirm";

function askPassword(){
const input = prompt("Enter password:");
return input === PASSWORD;
}

window.login = function(){
signInWithEmailAndPassword(auth, email.value, password.value)
.catch(err=>alert(err.message));
}

window.logout = function(){ signOut(auth); }

onAuthStateChanged(auth,(user)=>{
if(user){
authSection.style.display="none";
appSection.style.display="block";
loadIncomes();
loadCategories();
loadExpenses();
}else{
authSection.style.display="block";
appSection.style.display="none";
}
});

// Load incomes for dropdown
function loadIncomes(){
onValue(incomesRef,(snap)=>{
incomeSelect.innerHTML="";
snap.forEach(c=>{
const opt=document.createElement("option");
opt.value=c.key;
opt.textContent=c.val().desc;
incomeSelect.appendChild(opt);
});
});
}

// Load categories
function loadCategories(){
onValue(categoriesRef,(snap)=>{
categorySelect.innerHTML="";
snap.forEach(c=>{
const opt=document.createElement("option");
opt.value=c.val().name;
opt.textContent=c.val().name;
categorySelect.appendChild(opt);
});
});
}

// Add expense
window.addExpense=async function(){
if(!askPassword()) return;

const desc=descInput.value.trim();
const amount=parseFloat(amountInput.value);
const cat=categorySelect.value;
const incomeId=incomeSelect.value;

if(!desc||!cat||isNaN(amount)) return alert("Fill all fields!");

const incSnap=await get(ref(db,"expenses/incomes/"+incomeId));
if(!incSnap.exists()) return;

const income=incSnap.val();
if(income.remaining<amount) return alert("Not enough balance!");

const newRef=push(expensesRef);

const updates={};
updates[`expenses/incomes/${incomeId}/remaining`]=income.remaining-amount;
updates[`expenses/items/${newRef.key}`]={
desc,amount,category:cat,incomeName:income.desc,incomeId,date:Date.now()
};

await update(ref(db),updates);

descInput.value="";
amountInput.value="";
}

// Load expenses
function loadExpenses(){
onValue(expensesRef,(snap)=>{
list.innerHTML="";
snap.forEach(c=>{
const e=c.val();
const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<strong>${e.desc}</strong> - â‚¹${e.amount} (${e.category})
<small>From: ${e.incomeName}</small>
<div class="actions">
<button class="delete" onclick="deleteExpense('${c.key}','${e.incomeId}',${e.amount})">Delete</button>
</div>`;
list.prepend(div);
});
});
}

// Delete single expense
window.deleteExpense=async function(id,incomeId,amt){
if(!askPassword()) return;
if(!confirm("Delete expense?")) return;

const incSnap=await get(ref(db,"expenses/incomes/"+incomeId));
if(!incSnap.exists()) return;

const rem=incSnap.val().remaining||0;

const updates={};
updates[`expenses/incomes/${incomeId}/remaining`]=rem+amt;
updates[`expenses/items/${id}`]=null;

await update(ref(db),updates);
}

// ===== DELETE ALL EXPENSES (NEW) =====
window.deleteAllExpenses = async function(){
if(!askPassword()) return;
if(!confirm("Delete ALL expenses?")) return;

// Get all incomes
const incSnap = await get(incomesRef);
if(!incSnap.exists()) return;

// Reset remaining = amount
const updates = {};
incSnap.forEach(c=>{
const inc = c.val();
updates[`expenses/incomes/${c.key}/remaining`] = inc.amount;
});

// Remove all expense items
updates[`expenses/items`] = null;

await update(ref(db), updates);

alert("All expenses deleted");
}
</script>

</body>
</html>
