<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expenses Manager</title>

<style>
body{font-family:Arial;margin:0;background:#f9fafb}
.container{max-width:500px;margin:auto;padding:15px}
.card{background:#fff;padding:12px;margin-bottom:10px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
input,select,button{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:1px solid #ccc}
button{background:#4f46e5;color:#fff;border:none}
button:hover{background:#4338ca}
.delete{background:#dc2626}
.delete:hover{background:#b91c1c}
h2{text-align:center}
.actions{margin-top:8px}
</style>
</head>

<body>
<div class="container">
<h2>ðŸ’° Expenses Manager</h2>

<div id="authSection">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<div id="appSection" style="display:none">

<div class="card">
Income: â‚¹<span id="totalIncome">0</span><br>
Expenses: â‚¹<span id="totalExpenses">0</span><br>
Remaining: â‚¹<span id="totalRemaining">0</span>
</div>

<div class="card">
<h3>Add Income</h3>
<input id="incomeDesc" placeholder="Source">
<input id="incomeAmount" type="number" placeholder="Amount">
<button onclick="saveIncome()">Save Income</button>
<div id="incomeList"></div>
</div>

<div class="card">
<h3>Add Category</h3>
<input id="catInput" placeholder="Category">
<button onclick="addCategory()">Add Category</button>
</div>

<div class="card">
<h3>Add Expense</h3>
<input id="descInput" placeholder="Description">
<input id="amountInput" type="number" placeholder="Amount">
<select id="categorySelect"></select>
<select id="incomeSelect"></select>
<button onclick="addExpense()">Add Expense</button>
</div>

<button class="delete" id="deleteAllBtn">Delete All Expenses</button>

<h3>Expenses</h3>
<div id="list"></div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
authDomain:"striped-acrobat-342207.firebaseapp.com",
databaseURL:"https://striped-acrobat-342207-default-rtdb.firebaseio.com",
projectId:"striped-acrobat-342207"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const auth=getAuth(app);

const incomesRef=ref(db,"expenses/incomes");
const expensesRef=ref(db,"expenses/items");
const categoriesRef=ref(db,"expenses/categories");

const PASSWORD="Confirm";

function askDeletePassword(){
const input=prompt("Enter password to delete:");
if(input===null) return false;
if(input!==PASSWORD){
alert("âŒ Incorrect password!");
return false;
}
return true;
}

window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
window.logout=()=>signOut(auth);

onAuthStateChanged(auth,user=>{
if(user){
authSection.style.display="none";
appSection.style.display="block";
loadIncomes();
loadCategories();
loadExpenses();
}else{
authSection.style.display="block";
appSection.style.display="none";
}
});

/* INCOME */
window.saveIncome=async()=>{
const desc=incomeDesc.value.trim();
const amt=parseFloat(incomeAmount.value);
if(!desc||isNaN(amt)) return;
await push(incomesRef,{desc,amount:amt,remaining:amt});
incomeDesc.value=""; incomeAmount.value="";
};

function loadIncomes(){
onValue(incomesRef,snap=>{
incomeSelect.innerHTML="";
let total=0,remain=0;

snap.forEach(c=>{
const i=c.val();
total+=+i.amount;
remain+=+i.remaining;

const opt=document.createElement("option");
opt.value=c.key;
opt.textContent=i.desc;
incomeSelect.appendChild(opt);
});

totalIncome.innerText=total;
totalRemaining.innerText=remain;
});
}

/* CATEGORY */
window.addCategory=async()=>{
const name=catInput.value.trim();
if(!name) return;
await push(categoriesRef,{name});
catInput.value="";
};

function loadCategories(){
onValue(categoriesRef,snap=>{
categorySelect.innerHTML="";
snap.forEach(c=>{
const opt=document.createElement("option");
opt.value=c.val().name;
opt.textContent=c.val().name;
categorySelect.appendChild(opt);
});
});
}

/* EXPENSE */
window.addExpense=async()=>{
const desc=descInput.value.trim();
const amt=parseFloat(amountInput.value);
const cat=categorySelect.value;
const incomeId=incomeSelect.value;
if(!desc||!cat||isNaN(amt)) return;

const incSnap=await get(ref(db,"expenses/incomes/"+incomeId));
const inc=incSnap.val();
if(inc.remaining<amt) return alert("Not enough balance");

const newRef=push(expensesRef);
const updates={};
updates[`expenses/incomes/${incomeId}/remaining`]=inc.remaining-amt;
updates[`expenses/items/${newRef.key}`]={
desc,amount:amt,category:cat,incomeId,date:Date.now()
};
await update(ref(db),updates);

descInput.value=""; amountInput.value="";
};

function loadExpenses(){
onValue(expensesRef,snap=>{
list.innerHTML="";
let total=0;

snap.forEach(c=>{
const e=c.val();
total+=+e.amount;

const div=document.createElement("div");
div.className="card";
div.innerHTML=`
${e.desc} - â‚¹${e.amount} (${e.category})
<div class="actions">
<button class="delete" data-id="${c.key}" data-incomeid="${e.incomeId}" data-amount="${e.amount}">Delete</button>
</div>`;

list.prepend(div);
});

totalExpenses.innerText=total;

/* SINGLE DELETE */
document.querySelectorAll(".delete").forEach(btn=>{
btn.onclick=async()=>{
if(!askDeletePassword()) return;
if(!confirm("Delete expense?")) return;

const id=btn.dataset.id;
const incomeId=btn.dataset.incomeid;
const amt=+btn.dataset.amount;

const incSnap=await get(ref(db,"expenses/incomes/"+incomeId));
const rem=incSnap.val().remaining||0;

const updates={};
updates[`expenses/incomes/${incomeId}/remaining`]=rem+amt;
updates[`expenses/items/${id}`]=null;

await update(ref(db),updates);
};
});
});
}

/* DELETE ALL */
document.getElementById("deleteAllBtn").onclick=async()=>{
if(!askDeletePassword()) return;
if(!confirm("Delete ALL expenses?")) return;

const incSnap=await get(incomesRef);
const updates={};

incSnap.forEach(c=>{
const i=c.val();
updates[`expenses/incomes/${c.key}/remaining`]=i.amount;
});

updates["expenses/items"]=null;

await update(ref(db),updates);

alert("All expenses deleted & balances restored!");
};
</script>
</body>
</html>
