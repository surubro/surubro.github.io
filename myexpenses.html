<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Expenses Manager</title>

<style>
body { font-family: Arial; margin: 0; background: #f9fafb; }
.container { max-width: 500px; margin: auto; padding: 20px; }
.card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
input, select, button { width: 100%; padding: 10px; margin: 6px 0; border-radius: 8px; border: 1px solid #ccc; }
button { background: #4f46e5; color: white; border: none; cursor: pointer; }
button:hover { background: #4338ca; }
.delete { background: #dc2626; }
.delete:hover { background: #b91c1c; }
.inline-btn { padding:4px 8px; border-radius:6px; cursor:pointer; border:none; color:white; }
.edit-btn { background:#2563eb; }
.delete-btn { background:#dc2626; }
.income-text { color:#16a34a; font-weight:bold; }
.expense-text { color:#dc2626; font-weight:bold; }
.remaining-text { color:#2563eb; font-weight:bold; }
</style>
</head>

<body>
<div class="container">
<h2>ðŸ’° Expenses Manager</h2>

<div id="authSection">
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<div id="appSection" style="display:none;">

<div class="card">
Summary â€”
<span class="income-text">Income: â‚¹<span id="totalIncome">0</span></span> |
<span class="expense-text">Expenses: â‚¹<span id="totalExpenses">0</span></span> |
<span class="remaining-text">Remaining: â‚¹<span id="totalRemaining">0</span></span>
</div>

<!-- Income -->
<div class="card">
<h3>Add Income</h3>
<input id="incomeDesc" placeholder="Income Source">
<input id="incomeAmount" type="number" placeholder="Amount">
<button id="incomeBtn" onclick="saveIncome()">Save Income</button>
<div id="incomeSummary"></div>
</div>

<!-- Category -->
<div class="card">
<h3>Categories</h3>
<input id="catInput" placeholder="Category Name">
<button onclick="addCategory()">Add Category</button>
<div id="catList"></div>
</div>

<!-- Expense -->
<div class="card">
<h3>Add Expense</h3>
<input id="descInput" placeholder="Description">
<input id="amountInput" type="number" placeholder="Amount">
<select id="categorySelect"></select>
<select id="incomeSelect"></select>
<button onclick="addExpense()">Add Expense</button>
</div>

<button class="delete" id="deleteAllBtn">Delete All Expenses</button>

<h3>Expenses</h3>
<div id="list"></div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
authDomain:"striped-acrobat-342207.firebaseapp.com",
databaseURL:"https://striped-acrobat-342207-default-rtdb.firebaseio.com",
projectId:"striped-acrobat-342207"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const incomesRef = ref(db,"expenses/incomes");
const expensesRef = ref(db,"expenses/items");
const categoriesRef = ref(db,"expenses/categories");

const PASSWORD="Confirm";
function askDeletePassword(){
const input=prompt("Enter password to delete:");
if(input===null) return false;
if(input!==PASSWORD){ alert("âŒ Incorrect password!"); return false; }
return true;
}

window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
window.logout=()=>signOut(auth);

onAuthStateChanged(auth,user=>{
if(user){
authSection.style.display="none";
appSection.style.display="block";
loadIncomes(); loadCategories(); loadExpenses();
}else{
authSection.style.display="block";
appSection.style.display="none";
}
});

/* INCOME */
let editingIncomeId=null;
window.saveIncome=async()=>{
const desc=incomeDesc.value.trim();
const amount=parseFloat(incomeAmount.value);
if(!desc||isNaN(amount)) return;

if(editingIncomeId){
await update(ref(db,"expenses/incomes/"+editingIncomeId),{desc,amount,remaining:amount});
editingIncomeId=null;
incomeBtn.innerText="Save Income";
}else{
await push(incomesRef,{desc,amount,remaining:amount,date:Date.now()});
}
incomeDesc.value=""; incomeAmount.value="";
};

function loadIncomes(){
onValue(incomesRef,snap=>{
incomeSummary.innerHTML=""; incomeSelect.innerHTML="";
let totalIncome=0,totalRemaining=0;

snap.forEach(c=>{
const i=c.val();
totalIncome+=+i.amount;
totalRemaining+=+i.remaining;

const row=document.createElement("div");
row.innerHTML=`
<strong>${i.desc}</strong> â€” â‚¹${i.remaining}
<button class="inline-btn edit-btn" data-id="${c.key}" data-desc="${i.desc}" data-amount="${i.amount}">Edit</button>
<button class="inline-btn delete-btn" data-id="${c.key}">Delete</button>`;
incomeSummary.appendChild(row);

const opt=document.createElement("option");
opt.value=c.key; opt.textContent=i.desc;
incomeSelect.appendChild(opt);
});

totalIncome.innerText=totalIncome;
totalRemaining.innerText=totalRemaining;

/* Income Delete */
document.querySelectorAll(".delete-btn").forEach(btn=>{
btn.onclick=async()=>{
if(!askDeletePassword()) return;
if(!confirm("Delete income?")) return;
await remove(ref(db,"expenses/incomes/"+btn.dataset.id));
};
});

/* Income Edit */
document.querySelectorAll(".edit-btn").forEach(btn=>{
btn.onclick=()=>{
editingIncomeId=btn.dataset.id;
incomeDesc.value=btn.dataset.desc;
incomeAmount.value=btn.dataset.amount;
incomeBtn.innerText="Update Income";
};
});
});
}

/* CATEGORY */
window.addCategory=async()=>{
const name=catInput.value.trim();
if(!name) return;
await push(categoriesRef,{name});
catInput.value="";
};

function loadCategories(){
onValue(categoriesRef,snap=>{
catList.innerHTML=""; categorySelect.innerHTML="";
snap.forEach(c=>{
const cat=c.val();
const div=document.createElement("div");
div.innerHTML=`
${cat.name}
<button class="inline-btn delete-btn" data-id="${c.key}">Delete</button>`;
catList.appendChild(div);

const opt=document.createElement("option");
opt.value=cat.name; opt.textContent=cat.name;
categorySelect.appendChild(opt);
});

document.querySelectorAll("#catList .delete-btn").forEach(btn=>{
btn.onclick=async()=>{
if(!askDeletePassword()) return;
if(!confirm("Delete category?")) return;
await remove(ref(db,"expenses/categories/"+btn.dataset.id));
};
});
});
}

/* EXPENSE */
window.addExpense=async()=>{
const desc=descInput.value.trim();
const amount=parseFloat(amountInput.value);
const cat=categorySelect.value;
const incomeId=incomeSelect.value;
if(!desc||!cat||isNaN(amount)) return;

const incSnap=await get(ref(db,"expenses/incomes/"+incomeId));
const income=incSnap.val();
if(income.remaining<amount) return alert("Not enough balance!");

const newRef=push(expensesRef);
const updates={};
updates[`expenses/incomes/${incomeId}/remaining`]=income.remaining-amount;
updates[`expenses/items/${newRef.key}`]={desc,amount,category:cat,incomeId,date:Date.now()};
await update(ref(db),updates);

descInput.value=""; amountInput.value="";
};

function loadExpenses(){
onValue(expensesRef,snap=>{
list.innerHTML=""; let total=0;
snap.forEach(c=>{
const e=c.val();
total+=+e.amount;
const div=document.createElement("div");
div.className="card";
div.innerHTML=`
${e.desc} - â‚¹${e.amount} (${e.category})
<button class="delete" data-id="${c.key}" data-incomeid="${e.incomeId}" data-amount="${e.amount}">Delete</button>`;
list.prepend(div);
});
totalExpenses.innerText=total;

document.querySelectorAll(".delete").forEach(btn=>{
btn.onclick=async()=>{
if(!askDeletePassword()) return;
if(!confirm("Delete expense?")) return;

const id=btn.dataset.id;
const incomeId=btn.dataset.incomeid;
const amt=+btn.dataset.amount;

const incSnap=await get(ref(db,"expenses/incomes/"+incomeId));
const rem=incSnap.val().remaining||0;

const updates={};
updates[`expenses/incomes/${incomeId}/remaining`]=rem+amt;
updates[`expenses/items/${id}`]=null;
await update(ref(db),updates);
};
});
});
}

/* DELETE ALL */
document.getElementById("deleteAllBtn").onclick=async()=>{
if(!askDeletePassword()) return;
if(!confirm("Delete ALL expenses?")) return;

const incSnap=await get(incomesRef);
const updates={};
incSnap.forEach(c=>{
const i=c.val();
updates[`expenses/incomes/${c.key}/remaining`]=i.amount;
});
updates["expenses/items"]=null;
await update(ref(db),updates);
};
</script>
</body>
</html>
