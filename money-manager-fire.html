<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bank Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;background:#f5f5f5;padding:15px}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:12px}
.hidden{display:none}
input,select,button{width:100%;padding:8px;margin-bottom:8px}
button{background:#2ecc71;color:#fff;border:none;cursor:pointer}
.logout{background:#e74c3c}
.edit{background:#3498db}
.del{background:#e74c3c}
small{color:#555}
</style>
</head>
<body>

<!-- üîê LOGIN -->
<div id="loginBox" class="card">
<h2>üîê Login</h2>
<input id="email" placeholder="Email">
<input id="password" type="password">
<button onclick="login()">Login</button>
<button onclick="register()">Register</button>
</div>

<!-- üí∞ APP -->
<div id="app" class="hidden">

<button class="logout" onclick="logout()">Logout</button>

<div class="card">
<h3>Add / Update Bank</h3>
<input id="bankName" placeholder="Bank name (sbi)">
<input id="bankBalance" type="number" placeholder="Balance">
<button onclick="saveBank()">Save Bank</button>
</div>

<div class="card">
<h3 id="entryTitle">Add Entry</h3>
<select id="entryBank"></select>
<input id="entryName" placeholder="Entry name">
<input id="entryAmount" type="number" placeholder="Amount">
<input type="hidden" id="editId">
<button onclick="saveEntry()">Save Entry</button>
<button onclick="cancelEdit()" id="cancelBtn" class="hidden">Cancel Edit</button>
</div>

<div id="banks"></div>
<div class="card" id="grand"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getDatabase,
  ref,
  set,
  push,
  onValue,
  remove,
  update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
  authDomain: "striped-acrobat-342207.firebaseapp.com",
  databaseURL: "https://striped-acrobat-342207-default-rtdb.firebaseio.com",
  projectId: "striped-acrobat-342207",
  storageBucket: "striped-acrobat-342207.appspot.com",
  messagingSenderId: "367114842706",
  appId: "1:367114842706:web:0f6d504163ed3c72ed658b"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getDatabase(appFB);

let banksRef;

/* üîê AUTH STATE */
onAuthStateChanged(auth,user=>{
  if(user){
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    banksRef = ref(db, `bankManager/users/${user.uid}/banks`);
    loadBanks();
  }else{
    loginBox.classList.remove("hidden");
    app.classList.add("hidden");
  }
});

/* AUTH */
window.login = () =>
  signInWithEmailAndPassword(auth,email.value,password.value)
  .catch(e=>alert(e.message));

window.register = () =>
  createUserWithEmailAndPassword(auth,email.value,password.value)
  .catch(e=>alert(e.message));

window.logout = ()=>signOut(auth);

/* BANK */
window.saveBank = ()=>{
  const name = bankName.value.trim().toLowerCase();
  const bal = Number(bankBalance.value);
  if(!name) return;
  set(ref(db, `bankManager/users/${auth.currentUser.uid}/banks/${name}`), {
    balance: bal,
    entries: {}
  });
  bankName.value=""; bankBalance.value="";
};

/* ENTRY ADD / UPDATE */
window.saveEntry = ()=>{
  const bank = entryBank.value;
  if(!bank) return;

  const data = {
    name: entryName.value,
    amount: Number(entryAmount.value)
  };

  if(editId.value){
    update(ref(db, `bankManager/users/${auth.currentUser.uid}/banks/${bank}/entries/${editId.value}`), data);
  }else{
    push(ref(db, `bankManager/users/${auth.currentUser.uid}/banks/${bank}/entries`), data);
  }

  cancelEdit();
};

/* EDIT ENTRY */
window.editEntry = (bank,id,name,amount)=>{
  entryBank.value = bank;
  entryName.value = name;
  entryAmount.value = amount;
  editId.value = id;
  entryTitle.textContent = "Edit Entry";
  cancelBtn.classList.remove("hidden");
};

/* DELETE ENTRY */
window.delEntry = (bank,id)=>{
  if(confirm("Delete entry?")){
    remove(ref(db, `bankManager/users/${auth.currentUser.uid}/banks/${bank}/entries/${id}`));
  }
};

/* CANCEL EDIT */
window.cancelEdit = ()=>{
  entryName.value="";
  entryAmount.value="";
  editId.value="";
  entryTitle.textContent="Add Entry";
  cancelBtn.classList.add("hidden");
};

/* LOAD */
function loadBanks(){
  onValue(banksRef,snap=>{
    const data = snap.val()||{};
    let html="", gb=0, gu=0;
    entryBank.innerHTML="<option value=''>Select Bank</option>";

    for(const b in data){
      entryBank.innerHTML+=`<option value="${b}">${b}</option>`;
      let used=0;
      html+=`<div class="card"><h4>${b.toUpperCase()}</h4>`;

      if(data[b].entries){
        for(const id in data[b].entries){
          const e=data[b].entries[id];
          used+=e.amount;
          html+=`
            <small>${e.name} ‚Äì ‚Çπ${e.amount}</small><br>
            <button class="edit" onclick="editEntry('${b}','${id}','${e.name}',${e.amount})">‚úèÔ∏è</button>
            <button class="del" onclick="delEntry('${b}','${id}')">‚ùå</button><br><br>`;
        }
      }

      const rem=data[b].balance-used;
      html+=`<p>Balance ‚Çπ${data[b].balance} | Used ‚Çπ${used} | Remaining ‚Çπ${rem}</p></div>`;
      gb+=data[b].balance; gu+=used;
    }

    banks.innerHTML=html;
    grand.innerHTML=`üè¶ Total Balance ‚Çπ${gb} | Used ‚Çπ${gu} | Remaining ‚Çπ${gb-gu}`;
  });
}
</script>

</body>
</html>
