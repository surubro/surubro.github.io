<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Spending</title>
<style>
body{font-family:Arial;margin:0;background:#f9fafb}
.container{max-width:600px;margin:auto;padding:15px}
h2{text-align:center}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
button.danger{background:#dc2626}
button.green{background:#16a34a}
.collapsible{background:#eef2ff;padding:12px;border-radius:12px;margin:10px 0}
.collapsible h3{margin:0;cursor:pointer;display:flex;justify-content:space-between}
.collapsible-content{display:none;margin-top:8px}
.expense{color:#dc2626;font-weight:bold}
.income{color:#16a34a;font-weight:bold}
.muted{color:#6b7280;font-size:13px}
</style>
</head>
<body>
<div class="container">
<h2>ðŸ’° My Spending</h2>

<!-- LOGIN -->
<div id="authSection" class="card">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
<button id="logoutBtn">Logout</button>
</div>

<!-- APP -->
<div id="appSection" style="display:none">

<div class="collapsible">
<h3>
Summary
<span>
<span class="expense">Spent â‚¹<span id="totalExpenses">0</span></span> |
<b>Remaining â‚¹<span id="remaining">0</span></b>
</span>
</h3>
<div class="collapsible-content">
<div class="income">Total Income â‚¹<span id="totalIncome">0</span></div>
<div id="categorySummary"></div>
</div>
</div>

<div class="collapsible">
<h3>Salary</h3>
<div class="collapsible-content">
<input id="salaryName" placeholder="Income Source">
<input id="salaryAmount" type="number" placeholder="Amount">
<button id="saveSalaryBtn">Save / Update</button>
<div id="salaryList"></div>
</div>
</div>

<div class="collapsible">
<h3>Inward Cash</h3>
<div class="collapsible-content">
<input id="inwardName" placeholder="Name / Source">
<input id="inwardAmount" type="number" placeholder="Amount">
<button id="saveInwardBtn">Save Inward Cash</button>
<div id="inwardList"></div>
</div>
</div>

<div class="collapsible">
<h3>Categories</h3>
<div class="collapsible-content">
<input id="categoryName" placeholder="Category Name">
<button id="saveCategoryBtn">Save Category</button>
<div id="categoryList"></div>
</div>
</div>

<div class="card">
<h3>Add Expense</h3>
<input id="descInput" placeholder="Description">
<input id="amountInput" type="number" placeholder="Amount">
<select id="categorySelect"></select>
<button id="addExpenseBtn">Add Expense</button>
</div>

<div class="card">
<button class="green" id="exportCSVBtn">â¬‡ Export CSV</button>
<button class="danger" id="deleteAllBtn">ðŸ—‘ Delete ALL Expenses</button>
</div>

<h3>Expense List</h3>
<div id="list"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
  authDomain: "striped-acrobat-342207.firebaseapp.com",
  databaseURL: "https://striped-acrobat-342207-default-rtdb.firebaseio.com",
  projectId: "striped-acrobat-342207"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const salariesRef = ref(db, "spending/salaries");
const categoriesRef = ref(db, "spending/categories");
const itemsRef = ref(db, "spending/items");
const inwardRef = ref(db, "spending/inwardCash");

const DELETE_PASSWORD = "Confirm";
const confirmDelete = () => prompt("Enter delete password") === DELETE_PASSWORD;

let editSalaryId = null;

// Elements
const authSection = document.getElementById("authSection");
const appSection = document.getElementById("appSection");

const emailEl = document.getElementById("email");
const passwordEl = document.getElementById("password");

const totalIncomeEl = document.getElementById("totalIncome");
const totalExpensesEl = document.getElementById("totalExpenses");
const remainingEl = document.getElementById("remaining");
const categorySummaryEl = document.getElementById("categorySummary");

const salaryNameEl = document.getElementById("salaryName");
const salaryAmountEl = document.getElementById("salaryAmount");
const salaryListEl = document.getElementById("salaryList");

const inwardNameEl = document.getElementById("inwardName");
const inwardAmountEl = document.getElementById("inwardAmount");
const inwardListEl = document.getElementById("inwardList");

const categoryNameEl = document.getElementById("categoryName");
const categorySelectEl = document.getElementById("categorySelect");
const categoryListEl = document.getElementById("categoryList");

const descInputEl = document.getElementById("descInput");
const amountInputEl = document.getElementById("amountInput");
const listEl = document.getElementById("list");

// LOGIN / LOGOUT
document.getElementById("loginBtn").onclick = async () => {
  const email = emailEl.value.trim();
  const password = passwordEl.value.trim();
  if (!email || !password) { alert("Enter email & password"); return; }
  try { await signInWithEmailAndPassword(auth, email, password); }
  catch(err){ alert("Login failed: " + err.message); }
};

document.getElementById("logoutBtn").onclick = async () => {
  try { await signOut(auth); }
  catch(err){ alert("Logout failed: "+err.message); }
};

onAuthStateChanged(auth, u => {
  if(u){
    authSection.style.display = "none";
    appSection.style.display = "block";
    loadSalaries(); loadCategories(); loadExpenses(); loadInward();
  } else {
    authSection.style.display = "block";
    appSection.style.display = "none";
  }
});

// Collapsible sections
document.querySelectorAll(".collapsible h3").forEach(h=>{
  h.onclick = ()=>{ const c=h.nextElementSibling; c.style.display=c.style.display=="block"?"none":"block"; }
});

// --- SALARY ---
document.getElementById("saveSalaryBtn").onclick = async () => {
  const name = salaryNameEl.value.trim();
  const amt = +salaryAmountEl.value;
  if (!name || amt <=0) return;
  if(editSalaryId){ await update(ref(db,"spending/salaries/"+editSalaryId), {name, amount:amt}); editSalaryId=null; }
  else await push(salariesRef, {name, amount:amt});
  salaryNameEl.value = salaryAmountEl.value = "";
};

function loadSalaries(){ onValue(salariesRef, s=>{
  salaryListEl.innerHTML = "";
  s.forEach(c=>{
    const v = c.val();
    salaryListEl.innerHTML += `${v.name}: â‚¹${v.amount} <button onclick="editSalary('${c.key}','${v.name}',${v.amount})">Edit</button> <button onclick="deleteSalary('${c.key}')">Delete</button><br>`;
  });
  updateTotals();
}}
window.editSalary = (id,n,a)=>{ editSalaryId=id; salaryNameEl.value=n; salaryAmountEl.value=a; }
window.deleteSalary = async(id)=>{ if(!confirmDelete()) return; await remove(ref(db,"spending/salaries/"+id)); updateTotals(); }

// --- INWARD ---
document.getElementById("saveInwardBtn").onclick = async ()=>{
  const name = inwardNameEl.value.trim(); const amt = +inwardAmountEl.value;
  if(!name||amt<=0) return;
  await push(inwardRef, {name, amount:amt, date: Date.now()});
  inwardNameEl.value = inwardAmountEl.value = "";
};
function loadInward(){ onValue(inwardRef, s=>{
  inwardListEl.innerHTML="";
  s.forEach(c=>{
    const v = c.val();
    inwardListEl.innerHTML += `${v.name}: â‚¹${v.amount} <button onclick="deleteInward('${c.key}')">Delete</button><br>`;
  });
  updateTotals();
}); }
window.deleteInward = async(id)=>{ if(!confirmDelete()) return; await remove(ref(db,"spending/inwardCash/"+id)); updateTotals(); }

// --- CATEGORIES ---
document.getElementById("saveCategoryBtn").onclick = async ()=>{
  const name = categoryNameEl.value.trim(); if(!name) return; await push(categoriesRef, {name}); categoryNameEl.value="";
};
function loadCategories(){ onValue(categoriesRef, s=>{
  categorySelectEl.innerHTML=""; categoryListEl.innerHTML="";
  s.forEach(c=>{
    categorySelectEl.innerHTML += `<option value="${c.key}">${c.val().name}</option>`;
    categoryListEl.innerHTML += `${c.val().name}<br>`;
  });
}); }

// --- EXPENSE ---
document.getElementById("addExpenseBtn").onclick = async ()=>{
  if(!confirm("Confirm add this expense?")) return;
  const desc = descInputEl.value.trim(); const amt = +amountInputEl.value;
  const catId = categorySelectEl.value;
  if(!desc||amt<=0) return;
  const catSnap = await get(ref(db,"spending/categories/"+catId));
  const catName = catSnap.exists()?catSnap.val().name:"Uncategorized";
  await push(itemsRef, {desc, amount:amt, category:catName, date: Date.now()});
  descInputEl.value = amountInputEl.value = "";
};

function loadExpenses(){ onValue(itemsRef,s=>{
  listEl.innerHTML=""; let totalExpenses=0; let catTotals={};
  s.forEach(c=>{
    const v=c.val();
    totalExpenses += v.amount;
    catTotals[v.category] = (catTotals[v.category]||0)+v.amount;
    listEl.innerHTML += `<div class="card"><b>${v.desc}</b> â‚¹${v.amount}<br><small class="muted">${v.category}</small><button onclick="deleteExpense('${c.key}')">Delete</button></div>`;
  });
  updateTotals(totalExpenses, catTotals);
}); }
window.deleteExpense = async(id)=>{ if(!confirmDelete()) return; await remove(ref(db,"spending/items/"+id)); }

// --- DELETE ALL ---
document.getElementById("deleteAllBtn").onclick = async ()=>{
  if(!confirmDelete()) return;
  const snap = await get(itemsRef);
  if(snap.exists()){ const promises=[]; snap.forEach(c=>promises.push(remove(ref(db,"spending/items/"+c.key))); await Promise.all(promises); alert("All expenses deleted!"); updateTotals(); }
};

// --- TOTALS ---
async function updateTotals(expOverride=null, catTotalsOverride=null){
  let totalIncome=0; let totalExpenses=expOverride!==null?expOverride:0; let catTotals = catTotalsOverride||{};
  const s1 = await get(salariesRef); const s2 = await get(inwardRef);
  if(s1.exists()) s1.forEach(c=>totalIncome+=c.val().amount);
  if(s2.exists()) s2.forEach(c=>totalIncome+=c.val().amount);
  if(expOverride===null){ const s3 = await get(itemsRef); if(s3.exists()) s3.forEach(c=>{ totalExpenses+=c.val().amount; catTotals[c.val().category]=(catTotals[c.val().category]||0)+c.val().amount; }); }
  totalIncomeEl.innerText = totalIncome;
  totalExpensesEl.innerText = totalExpenses;
  remainingEl.innerText = totalIncome-totalExpenses;
  updateCategorySummary(catTotals);
}

function updateCategorySummary(catTotals){
  categorySummaryEl.innerHTML="";
  const totalIncome = +totalIncomeEl.innerText||0;
  for(const cat in catTotals){ const p = totalIncome?((catTotals[cat]/totalIncome)*100).toFixed(1):0;
    categorySummaryEl.innerHTML += `${cat}: â‚¹${catTotals[cat]} (${p}%)<br>`;
  }
}

// --- CSV ---
document.getElementById("exportCSVBtn").onclick = async ()=>{
  let csv = "Type,Name/Description,Amount,Category,Date,Category %\n"; 
  const esc=v=>`"${String(v??"").replace(/"/g,'""')}"`;
  const s1 = await get(salariesRef); const s2 = await get(inwardRef); const s3 = await get(itemsRef);
  let totalIncome=0; if(s1.exists()) s1.forEach(c=>totalIncome+=c.val().amount); if(s2.exists()) s2.forEach(c=>totalIncome+=c.val().amount);
  let catTotals={}; if(s3.exists()) s3.forEach(c=>catTotals[c.val().category]=(catTotals[c.val().category]||0)+c.val().amount);
  if(s1.exists()) s1.forEach(c=>csv+=`Salary,${esc(c.val().name)},${c.val().amount},,,\n`);
  if(s2.exists()) s2.forEach(c=>csv+=`Inward Cash,${esc(c.val().name)},${c.val().amount},,${esc(new Date(c.val().date).toLocaleString())},\n`);
  if(s3.exists()) s3.forEach(c=>{ const p=totalIncome?((c.val().amount/totalIncome)*100).toFixed(1):0; csv+=`Expense,${esc(c.val().desc)},${c.val().amount},${esc(c.val().category)},${esc(new Date(c.val().date).toLocaleString())},${p}%\n`; });
  csv+="\nCategory Summary,,,\n"; for(const cat in catTotals){ const p = totalIncome?((catTotals[cat]/totalIncome)*100).toFixed(1):0; csv+=`${esc(cat)},${catTotals[cat]},,,${p}%\n`; }
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="spending_report.csv"; a.click();
};
</script>

</body>
</html>
