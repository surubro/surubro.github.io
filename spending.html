<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Spendings</title>
<style>
body{font-family:Arial;margin:0;background:#f9fafb}
.container{max-width:600px;margin:auto;padding:15px}
h2{text-align:center}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
button.danger{background:#dc2626}
button.green{background:#16a34a}
.collapsible{background:#eef2ff;padding:12px;border-radius:12px;margin:10px 0}
.collapsible h3{margin:0;cursor:pointer;display:flex;justify-content:space-between}
.collapsible-content{display:none;margin-top:8px}
.expense{color:#dc2626;font-weight:bold}
.income{color:#16a34a;font-weight:bold}
.muted{color:#6b7280;font-size:13px}
</style>
</head>
<body>
<div class="container">
<h2>ðŸ’° My Spending</h2>

<!-- AUTH -->
<div id="authSection" class="card">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<div id="appSection" style="display:none">

<!-- SUMMARY -->
<div class="collapsible">
<h3>
Summary
<span>
<span class="expense">Spent â‚¹<span id="totalExpenses">0</span></span> |
<b>Remaining â‚¹<span id="remaining">0</span></b>
</span>
</h3>
<div class="collapsible-content">
<div class="income">Total Income â‚¹<span id="totalIncome">0</span></div>
<div id="categorySummary"></div>
</div>
</div>

<!-- SALARY -->
<div class="collapsible">
<h3>Salary</h3>
<div class="collapsible-content">
<input id="salaryName" placeholder="Income Source">
<input id="salaryAmount" type="number" placeholder="Amount">
<button onclick="saveSalary()">Save / Update</button>
<div id="salaryList"></div>
</div>
</div>

<!-- INWARD CASH -->
<div class="collapsible">
<h3>Inward Cash</h3>
<div class="collapsible-content">
<input id="inwardName" placeholder="Name / Source">
<input id="inwardAmount" type="number" placeholder="Amount">
<button onclick="saveInward()">Save Inward Cash</button>
<div id="inwardList"></div>
</div>
</div>

<!-- CATEGORIES -->
<div class="collapsible">
<h3>Categories</h3>
<div class="collapsible-content">
<input id="categoryName" placeholder="Category Name">
<button onclick="saveCategory()">Save Category</button>
<div id="categoryList"></div>
</div>
</div>

<!-- ADD EXPENSE -->
<div class="card">
<h3>Add Expense</h3>
<input id="descInput" placeholder="Description">
<input id="amountInput" type="number" placeholder="Amount">
<select id="categorySelect"></select>
<button onclick="addExpense()">Add Expense</button>
</div>

<div class="card">
<button class="green" onclick="exportCSV()">â¬‡ Export CSV</button>
<button class="danger" onclick="deleteAllExpenses()">ðŸ—‘ Delete ALL Expenses</button>
</div>

<h3>Expense List</h3>
<div id="list"></div>

</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase,ref,push,onValue,remove,update,get} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import {getAuth,signInWithEmailAndPassword,signOut,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
authDomain:"striped-acrobat-342207.firebaseapp.com",
databaseURL:"https://striped-acrobat-342207-default-rtdb.firebaseio.com",
projectId:"striped-acrobat-342207"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const DELETE_PASSWORD = "Confirm";
const confirmDelete = () => prompt("Enter delete password")===DELETE_PASSWORD;

const salariesRef = ref(db,"spending/salaries");
const categoriesRef = ref(db,"spending/categories");
const itemsRef = ref(db,"spending/items");
const inwardRef = ref(db,"spending/inwardCash");

let editSalaryId = null;

/* AUTH */
window.login = async () => {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!email || !password){ alert("Enter email & password"); return; }
  try { await signInWithEmailAndPassword(auth,email,password); } 
  catch(err){ alert("Login failed: "+err.message); }
};
window.logout = async () => {
  try { await signOut(auth); } 
  catch(err){ alert("Logout failed: "+err.message); }
};

onAuthStateChanged(auth,u=>{
  document.getElementById("authSection").style.display = u?"none":"block";
  document.getElementById("appSection").style.display = u?"block":"none";
  if(u){ loadSalaries(); loadCategories(); loadExpenses(); loadInward(); }
});

/* COLLAPSIBLE */
document.querySelectorAll(".collapsible h3").forEach(h=>{
  h.onclick = ()=>{ const c=h.nextElementSibling; c.style.display=c.style.display=="block"?"none":"block"; }
});

/* SALARY */
window.saveSalary = async ()=>{
  const name=document.getElementById("salaryName").value.trim();
  const amt=+document.getElementById("salaryAmount").value;
  if(!name||amt<=0) return;
  if(editSalaryId){ await update(ref(db,"spending/salaries/"+editSalaryId),{name,amount:amt}); editSalaryId=null; }
  else await push(salariesRef,{name,amount:amt});
  document.getElementById("salaryName").value = document.getElementById("salaryAmount").value = "";
};
function loadSalaries(){ onValue(salariesRef,s=>{
  let list = document.getElementById("salaryList"); list.innerHTML="";
  s.forEach(c=>{ const v=c.val(); list.innerHTML+=`${v.name}: â‚¹${v.amount} <button onclick="editSalary('${c.key}','${v.name}',${v.amount})">Edit</button> <button onclick="deleteSalary('${c.key}')">Delete</button><br>`; });
  updateTotals();
});
}
window.editSalary=(id,n,a)=>{ editSalaryId=id; document.getElementById("salaryName").value=n; document.getElementById("salaryAmount").value=a; }
window.deleteSalary=async(id)=>{ if(!confirmDelete())return; await remove(ref(db,"spending/salaries/"+id)); updateTotals(); }

/* INWARD */
window.saveInward = async ()=>{ 
  const name=document.getElementById("inwardName").value.trim(); 
  const amt=+document.getElementById("inwardAmount").value; 
  if(!name||amt<=0)return; 
  await push(inwardRef,{name,amount:amt,date:Date.now()}); 
  document.getElementById("inwardName").value = document.getElementById("inwardAmount").value="";
};
function loadInward(){ onValue(inwardRef,s=>{
  let list=document.getElementById("inwardList"); list.innerHTML="";
  s.forEach(c=>{ const v=c.val(); list.innerHTML+=`${v.name}: â‚¹${v.amount} <button onclick="deleteInward('${c.key}')">Delete</button><br>`; });
  updateTotals();
}); }
window.deleteInward=async(id)=>{ if(!confirmDelete())return; await remove(ref(db,"spending/inwardCash/"+id)); updateTotals(); }

/* CATEGORIES */
window.saveCategory=async()=>{ const name=document.getElementById("categoryName").value.trim(); if(!name) return; await push(categoriesRef,{name}); document.getElementById("categoryName").value=""; }
function loadCategories(){ onValue(categoriesRef,s=>{
  const select=document.getElementById("categorySelect"); const list=document.getElementById("categoryList");
  select.innerHTML=""; list.innerHTML="";
  s.forEach(c=>{ select.innerHTML+=`<option value="${c.key}">${c.val().name}</option>`; list.innerHTML+=`${c.val().name}<br>`; });
}); }

/* EXPENSE */
window.addExpense=async()=>{
  if(!confirm("Confirm add this expense?")) return;
  const desc=document.getElementById("descInput").value.trim();
  const amt=+document.getElementById("amountInput").value;
  const catId=document.getElementById("categorySelect").value;
  if(!desc||amt<=0) return;
  const catSnap = await get(ref(db,"spending/categories/"+catId));
  const categoryNameValue = catSnap.exists()?catSnap.val().name:"Uncategorized";
  await push(itemsRef,{desc,amount:amt,category:categoryNameValue,date:Date.now()});
  document.getElementById("descInput").value = document.getElementById("amountInput").value = "";
};
function loadExpenses(){ onValue(itemsRef,s=>{
  const list=document.getElementById("list"); list.innerHTML="";
  let totalExpensesValue=0; let categoryTotals={};
  s.forEach(c=>{ const v=c.val(); totalExpensesValue+=v.amount; categoryTotals[v.category]=(categoryTotals[v.category]||0)+v.amount;
  list.innerHTML+=`<div class="card"><b>${v.desc}</b> â‚¹${v.amount}<br><small class="muted">${v.category}</small><button onclick="deleteExpense('${c.key}')">Delete</button></div>`; });
  updateTotals(totalExpensesValue, categoryTotals);
}); }
window.deleteExpense=async(id)=>{ if(!confirmDelete())return; await remove(ref(db,"spending/items/"+id)); }

/* DELETE ALL EXPENSES */
window.deleteAllExpenses=async()=>{
  if(!confirmDelete())return;
  const snapshot=await get(itemsRef);
  if(snapshot.exists()){ const promises=[]; snapshot.forEach(c=>promises.push(remove(ref(db,"spending/items/"+c.key))); await Promise.all(promises); alert("All expenses deleted!"); updateTotals(); }
};

/* UPDATE TOTALS */
async function updateTotals(expenseOverride=null, categoryTotalsOverride=null){
  const s1=await get(salariesRef); const s2=await get(inwardRef); const s3=await get(itemsRef);
  let totalIncomeValue=0; if(s1.exists()) s1.forEach(c=>totalIncomeValue+=c.val().amount);
  if(s2.exists()) s2.forEach(c=>totalIncomeValue+=c.val().amount);
  let totalExpensesValue = expenseOverride!==null ? expenseOverride : (s3.exists()? [...s3.val ? Object.values(s3.val()) : []].reduce((a,v)=>a+v.amount,0):0);
  document.getElementById("totalIncome").innerText=totalIncomeValue;
  document.getElementById("totalExpenses").innerText=totalExpensesValue;
  document.getElementById("remaining").innerText=totalIncomeValue-totalExpensesValue;
  const catTotals = categoryTotalsOverride!==null?categoryTotalsOverride:{};
  updateCategorySummary(catTotals);
}

/* UPDATE CATEGORY SUMMARY */
function updateCategorySummary(categoryTotals){
  const container=document.getElementById("categorySummary"); container.innerHTML=""; 
  const totalIncomeValue=+document.getElementById("totalIncome").innerText||0;
  for(const cat in categoryTotals){ const p=totalIncomeValue?((categoryTotals[cat]/totalIncomeValue)*100).toFixed(1):0;
  container.innerHTML+=`${cat}: â‚¹${categoryTotals[cat]} (${p}%)<br>`;}
}

/* EXPORT CSV */
window.exportCSV=async()=>{
  let csv="Type,Name/Description,Amount,Category,Date,Category %\n"; 
  const esc=v=>`"${String(v??"").replace(/"/g,'""')}"`;
  const s1=await get(salariesRef); const s2=await get(inwardRef); const s3=await get(itemsRef);
  let totalIncomeValue=0; if(s1.exists()) s1.forEach(c=>totalIncomeValue+=c.val().amount);
  if(s2.exists()) s2.forEach(c=>totalIncomeValue+=c.val().amount);
  let categoryTotals={}; if(s3.exists()) s3.forEach(c=>categoryTotals[c.val().category]=(categoryTotals[c.val().category]||0)+c.val().amount);
  if(s1.exists()) s1.forEach(c=>{ const v=c.val(); csv+=`Salary,${esc(v.name)},${v.amount},,,\n`; });
  if(s2.exists()) s2.forEach(c=>{ const v=c.val(); csv+=`Inward Cash,${esc(v.name)},${v.amount},,${esc(new Date(v.date).toLocaleString())},\n`; });
  if(s3.exists()) s3.forEach(c=>{ const v=c.val(); const p=totalIncomeValue?((v.amount/totalIncomeValue)*100).toFixed(1):0; csv+=`Expense,${esc(v.desc)},${v.amount},${esc(v.category)},${esc(new Date(v.date).toLocaleString())},${p}%\n`; });
  csv+="\nCategory Summary,,,\n"; for(const cat in categoryTotals){ const p=totalIncomeValue?((categoryTotals[cat]/totalIncomeValue)*100).toFixed(1):0; csv+=`${esc(cat)},${categoryTotals[cat]},,,${p}%\n`; }
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="full_spending_report.csv"; a.click();
};
</script>
</body>
</html>
