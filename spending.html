<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spending App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f9fafb;margin:0}
.container{max-width:600px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:10px}
button{padding:10px;width:100%;margin-top:8px}
</style>
</head>

<body>
<div class="container">

<h2>ðŸ’° Spending</h2>

<div class="card" id="auth">
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<div class="card" id="app" style="display:none">
  <button onclick="exportCSV()">â¬‡ Export CSV</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ðŸ”¥ YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBxbzsSi-dsFPPGDeogz2SaEsW_3OKu-QU",
  authDomain: "striped-acrobat-342207.firebaseapp.com",
  databaseURL: "https://striped-acrobat-342207-default-rtdb.firebaseio.com",
  projectId: "striped-acrobat-342207"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* AUTH */
window.login = () =>
  signInWithEmailAndPassword(auth, email.value, password.value);

onAuthStateChanged(auth, u => {
  auth.style.display = u ? "none" : "block";
  app.style.display  = u ? "block" : "none";
});

/* âœ… CSV EXPORT (FIXED) */
window.exportCSV = async () => {
  if (!auth.currentUser) {
    alert("Login first");
    return;
  }

  const esc = v => `"${String(v ?? "").replace(/"/g, '""')}"`;

  const salariesSnap = await get(ref(db, "spending/salaries"));
  const inwardSnap   = await get(ref(db, "spending/inwardCash"));
  const expensesSnap = await get(ref(db, "spending/items"));

  let csv = "Type,Name/Description,Amount,Category,Date\n";

  if (salariesSnap.exists()) {
    salariesSnap.forEach(c => {
      const v = c.val();
      csv += `Salary,${esc(v.name)},${v.amount},,\n`;
    });
  }

  if (inwardSnap.exists()) {
    inwardSnap.forEach(c => {
      const v = c.val();
      csv += `Inward Cash,${esc(v.name)},${v.amount},,${esc(new Date(v.date).toLocaleString())}\n`;
    });
  }

  if (expensesSnap.exists()) {
    expensesSnap.forEach(c => {
      const v = c.val();
      csv += `Expense,${esc(v.desc)},${v.amount},${esc(v.category)},${esc(new Date(v.date).toLocaleString())}\n`;
    });
  }

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "full_spending_report.csv";
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
